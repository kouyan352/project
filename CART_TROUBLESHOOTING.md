# 🛒 カート問題のトラブルシューティングガイド

## 📋 現在の問題

1. ✅ **数量が自動で5個になる**
2. ✅ **数量を変更しても更新されない** 
3. ✅ **チェックアウトに進むとホームページに戻される**

---

## 🔍 診断手順

### ステップ1: カートの状態を確認

1. **clear-cart.htmlを開く**
   - `file:///path/to/webapp/clear-cart.html` をブラウザで開く
   - 「カートを確認」ボタンをクリック
   - 現在のカート内容を確認

2. **ブラウザのコンソールを開く**
   - Chrome: `F12` → Consoleタブ
   - 商品ページで「カートに追加」をクリック
   - コンソールに表示される情報を確認:
     ```javascript
     Form data being sent: {...}
     Cart add response status: 200
     Successfully added to cart: {...}
     Item quantity: 1  // ← これが1であることを確認
     ```

3. **カートページでコンソールを確認**
   - `/cart` ページでF12を押してConsoleを開く
   - ページ読み込み時に表示される情報:
     ```javascript
     Cart page loaded
     Actual cart from API: {...}
     Item count: X  // ← ここが5になっている場合が問題
     ```

---

## 🔧 問題の原因と解決方法

### 問題1: 数量が5個になる原因

**可能性のある原因:**

1. **複数回「カートに追加」を押している**
   - 解決: カートをクリアして1回だけ追加

2. **ブラウザキャッシュの問題**
   - 解決: ハードリフレッシュ (`Ctrl + Shift + R`)

3. **商品ページのJavaScriptが複数回実行されている**
   - 解決: ページをリロードしてから1回だけ追加

**即座の解決方法:**

```html
<!-- clear-cart.htmlを使用 -->
1. clear-cart.htmlを開く
2. 「カートをクリア」ボタンをクリック
3. 商品ページに戻る
4. 数量「1」を確認
5. 1回だけ「カートに追加」をクリック
```

---

### 問題2: 数量変更が反映されない

**修正内容:**

以前のコードは**JavaScriptで表示を更新するだけ**でサーバーに送信していませんでした。

**修正版の動作:**

1. 数量を変更（+/- ボタンまたは直接入力）
2. **「カートを更新」ボタンをクリック** ← これが必須！
3. サーバーにFetch APIで送信
4. ページがリロードされて最新の状態を表示

**重要なポイント:**
- ✅ 数量を変更しただけでは**表示のみ**更新
- ✅ **「カートを更新」ボタンをクリック**してサーバーに反映
- ✅ ページリロード後に正しい価格が表示される

---

### 問題3: チェックアウトで戻される

**可能性のある原因:**

1. **サブスクリプション商品の設定が不完全**
   - Shopify管理画面で「購入オプション」を確認
   - サブスクリプションプランが正しく設定されているか

2. **カートの状態が不正**
   - selling_plan が正しく設定されていない
   - カートをクリアして再度追加

3. **チェックアウト設定の問題**
   - Shopify管理画面 → 設定 → チェックアウト
   - チェックアウトが有効になっているか確認

**デバッグ方法:**

```javascript
// ブラウザのコンソールで実行
fetch('/cart.js')
  .then(res => res.json())
  .then(cart => {
    console.log('Cart items:', cart.items);
    cart.items.forEach(item => {
      console.log('Selling plan:', item.selling_plan_allocation);
    });
  });
```

**解決手順:**

1. **カートをクリア**
   ```bash
   clear-cart.htmlで「カートをクリア」
   ```

2. **商品設定を確認**
   - Shopify管理画面 → 商品
   - 「購入オプション」セクションを確認
   - サブスクリプションプランが有効か確認

3. **再度追加**
   - 商品ページでサブスクリプションプランを選択
   - 数量を「1」に設定
   - 「カートに追加」を1回だけクリック

4. **チェックアウトテスト**
   - カートページで数量を確認（1個であることを確認）
   - 「レジに進む」をクリック
   - チェックアウトページが表示されることを確認

---

## 🎯 推奨される使用フロー

### 正しい商品購入フロー:

1. **商品ページ**
   - サブスクリプションプランを選択（必須）
   - 数量を設定（デフォルト: 1）
   - 「カートに追加」を**1回だけ**クリック
   - コンソール (F12) で確認: `Item quantity: 1`

2. **カートページ**
   - 商品が**1つだけ**表示される（上下に重複していない）
   - 数量が正しいか確認
   - **数量を変更した場合**: 
     - +/- ボタンで変更
     - **「カートを更新」ボタンをクリック** ← 必須！
     - ページがリロードされる
   - 価格が正しいか確認

3. **チェックアウト**
   - 「レジに進む」をクリック
   - コンソールで確認: `Cart state before checkout`
   - チェックアウトページで情報を入力
   - **ホームに戻されない**ことを確認

---

## 🐛 デバッグモード

### 商品ページのデバッグ情報:

カートに追加時、コンソールに以下が表示されます：

```javascript
Form data being sent: {
  form_type: "product",
  utf8: "✓",
  id: "商品ID",
  selling_plan: "プランID",
  quantity: "1"
}

Successfully added to cart: {
  id: 商品ID,
  quantity: 1,  // ← ここが1であることを確認
  selling_plan_allocation: {...}
}
```

### カートページのデバッグ情報:

ページ読み込み時、コンソールに以下が表示されます：

```javascript
Cart page loaded
Cart items count: 1  // ← DOMに表示される商品数
Actual cart from API: {
  item_count: 1,  // ← サーバー上の実際の商品数
  items: [
    {
      title: "商品名",
      quantity: 1,  // ← ここが1であることを確認
      price: 価格,
      line_price: 合計価格
    }
  ]
}
```

**数量が一致しない場合:**
- DOMの商品数: X個
- サーバーの商品数: Y個
→ **カートをクリアして再度追加**

---

## ✅ 修正内容まとめ

### product-info.liquid の変更点:

1. **重複追加防止**
   - `window.isAddingToCart` フラグで制御
   - 既に追加処理中の場合は新しいリクエストを無視

2. **デバッグ情報追加**
   - フォームデータをコンソールに出力
   - レスポンスデータをコンソールに出力
   - エラー詳細をコンソールに出力

### cart-section.liquid の変更点:

1. **カートAPI確認**
   - ページ読み込み時に `/cart.js` を呼び出し
   - 実際のカート状態をコンソールに出力

2. **「カートを更新」ボタンの改善**
   - Fetch APIで `/cart/update.js` にPOST送信
   - サーバーに数量変更を反映
   - 更新後にページをリロード

3. **デバッグログ追加**
   - 各操作をコンソールに出力
   - 問題の特定が容易に

---

## 📞 サポート

問題が解決しない場合:

1. **clear-cart.html** で カート状態を確認
2. **ブラウザコンソール** でエラーメッセージを確認
3. **Shopify管理画面** でサブスクリプション設定を確認
4. すべてのデバッグ情報をスクリーンショット

---

## 🔄 更新履歴

- **2025-11-07**: 初版作成
  - カート数量問題の診断手順追加
  - デバッグモード追加
  - clear-cart.htmlツール作成
  - product-info.liquidとcart-section.liquidを修正
