<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2D5F3F;
            margin-bottom: 20px;
        }
        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #b71c1c;
        }
        .info {
            background: #E8F5E9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2D5F3F;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background: #E8F5E9;
            color: #2D5F3F;
            display: block;
        }
        .status.error {
            background: #ffebee;
            color: #d32f2f;
            display: block;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ ã‚«ãƒ¼ãƒˆã‚¯ãƒªã‚¢ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="info">
            <h3>ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã§ãã‚‹ã“ã¨ï¼š</h3>
            <ul>
                <li>ã‚«ãƒ¼ãƒˆå†…ã®å…¨å•†å“ã‚’å‰Šé™¤</li>
                <li>ã‚«ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª</li>
                <li>å•é¡Œã®ã‚ã‚‹ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</li>
            </ul>
        </div>

        <div>
            <h3>ç¾åœ¨ã®ã‚«ãƒ¼ãƒˆçŠ¶æ…‹ï¼š</h3>
            <button onclick="checkCart()">ã‚«ãƒ¼ãƒˆã‚’ç¢ºèª</button>
            <button onclick="clearCart()">ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
            <button onclick="testCheckout()" style="background: #2D5F3F;">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div id="status" class="status"></div>
        
        <div id="cartData" style="margin-top: 20px;"></div>
    </div>

    <script>
        // ã‚«ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª
        async function checkCart() {
            const statusDiv = document.getElementById('status');
            const cartDataDiv = document.getElementById('cartData');
            
            try {
                const response = await fetch('/cart.js');
                const cart = await response.json();
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>ã‚«ãƒ¼ãƒˆç¢ºèªå®Œäº†</strong><br>
                    å•†å“æ•°: ${cart.item_count}å€‹<br>
                    åˆè¨ˆ: ${formatMoney(cart.total_price)}
                `;
                
                cartDataDiv.innerHTML = '<h3>ã‚«ãƒ¼ãƒˆã®è©³ç´°:</h3><pre>' + JSON.stringify(cart, null, 2) + '</pre>';
                
                if (cart.item_count > 0) {
                    console.log('Cart items:', cart.items);
                    cart.items.forEach((item, index) => {
                        console.log(`Item ${index + 1}:`, {
                            title: item.title,
                            quantity: item.quantity,
                            price: item.price,
                            selling_plan: item.selling_plan_allocation
                        });
                    });
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
                console.error('Error checking cart:', error);
            }
        }

        // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
        async function clearCart() {
            if (!confirm('ã‚«ãƒ¼ãƒˆå†…ã®å…¨å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const statusDiv = document.getElementById('status');
            const cartDataDiv = document.getElementById('cartData');
            
            statusDiv.className = 'status';
            statusDiv.innerHTML = 'å‡¦ç†ä¸­...';
            statusDiv.style.display = 'block';
            
            try {
                // ç¾åœ¨ã®ã‚«ãƒ¼ãƒˆã‚’å–å¾—
                const response = await fetch('/cart.js');
                const cart = await response.json();
                
                // å…¨å•†å“ã®æ•°é‡ã‚’0ã«è¨­å®š
                const updates = {};
                cart.items.forEach((item, index) => {
                    updates[(index + 1).toString()] = 0;
                });
                
                // ã‚«ãƒ¼ãƒˆã‚’æ›´æ–°
                const clearResponse = await fetch('/cart/update.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ updates: updates })
                });
                
                const clearedCart = await clearResponse.json();
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>âœ“ ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼</strong><br>
                    æ®‹ã‚Šå•†å“æ•°: ${clearedCart.item_count}å€‹
                `;
                
                cartDataDiv.innerHTML = '<p>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚</p>';
                
                // 3ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
                console.error('Error clearing cart:', error);
            }
        }

        // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatMoney(cents) {
            const yen = Math.floor(cents / 100);
            return 'Â¥' + yen.toLocaleString('ja-JP');
        }

        // ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ
        async function testCheckout() {
            const statusDiv = document.getElementById('status');
            
            statusDiv.className = 'status';
            statusDiv.innerHTML = 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’ãƒ†ã‚¹ãƒˆä¸­...';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch('/cart.js');
                const cart = await response.json();
                
                console.log('Cart before checkout:', cart);
                
                if (cart.item_count === 0) {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™';
                    return;
                }
                
                // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ç¢ºèª
                const subscriptionInfo = cart.items.map(item => ({
                    title: item.title,
                    quantity: item.quantity,
                    has_subscription: !!item.selling_plan_allocation,
                    selling_plan: item.selling_plan_allocation ? item.selling_plan_allocation.selling_plan.name : 'ãªã—'
                }));
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>âœ“ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæº–å‚™å®Œäº†</strong><br>
                    å•†å“æ•°: ${cart.item_count}å€‹<br>
                    <br>
                    <strong>å•†å“è©³ç´°:</strong><br>
                    ${subscriptionInfo.map(info => `
                        - ${info.title} (${info.quantity}å€‹)<br>
                        &nbsp;&nbsp;ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³: ${info.selling_plan}
                    `).join('<br>')}
                    <br><br>
                    <button onclick="window.location.href='/checkout'" style="background: #2D5F3F; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒšãƒ¼ã‚¸ã«é€²ã‚€
                    </button>
                `;
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + error.message;
                console.error('Error testing checkout:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¼ãƒˆã‚’ç¢ºèª
        window.addEventListener('load', checkCart);
    </script>
</body>
</html>
