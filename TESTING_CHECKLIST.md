# ✅ カート機能テストチェックリスト

## 🎯 テスト手順

### テスト1: カートの重複表示確認

**目的**: カートが1回だけ表示されることを確認

**手順**:
1. ブラウザで `/cart` にアクセス
2. ページ全体をスクロールして確認

**期待結果**:
- ✅ カートが**上部に1回だけ**表示される
- ❌ カートが上下に2回表示されていない

**失敗した場合**:
- ブラウザキャッシュをクリア: `Ctrl + Shift + R`
- 修正したファイルが正しくアップロードされているか確認

---

### テスト2: 数量更新の確認

**目的**: 数量変更がサーバーに保存されることを確認

**手順**:
1. ブラウザコンソールを開く (`F12` → Console)
2. カートページで数量を1に設定
3. +ボタンを1回クリック（数量が2になる）
4. **「カートを更新」ボタンをクリック**
5. ページがリロードされるのを待つ
6. 数量が2のまま表示されることを確認
7. 価格が2倍になっていることを確認

**期待結果**:
- ✅ +/-ボタンで表示が即座に変わる
- ✅ 「カートを更新」をクリックするとページリロード
- ✅ リロード後も数量が保持される
- ✅ 価格が正しく計算される

**コンソール出力の確認**:
```javascript
Quantity changed for line 1: 2
Updating cart...
Line 1: quantity = 2
Form submitting with values:
updates[] = 2
```

**失敗した場合**:
- コンソールにエラーが表示されていないか確認
- `cart-section.liquid` が正しくアップロードされているか確認

---

### テスト3: チェックアウトの確認

**目的**: チェックアウトでホームに戻されないことを確認

**手順**:
1. ブラウザコンソールを開く (`F12` → Console)
2. カートに商品が1個以上あることを確認
3. 「レジに進む」ボタンをクリック
4. チェックアウトページが表示されるまで待つ（3-5秒）
5. URLが `/checkout` になっていることを確認
6. クレジットカード入力フォームが表示されることを確認

**期待結果**:
- ✅ 「レジに進む」をクリック後、チェックアウトページに遷移
- ✅ クレジットカード入力画面が表示される
- ❌ ホームページにリダイレクトされない
- ❌ カートページに戻らない

**コンソール出力の確認**:
```javascript
Proceeding to checkout...
Cart state before checkout: {item_count: 1, items: [...]}
Has subscription items: true (または false)
```

**失敗した場合**:
- コンソールにエラーメッセージが表示されていないか確認
- カートが空でないか確認 (`clear-cart.html` でカート状態を確認)
- サブスクリプションプランが正しく設定されているか確認

---

## 🐛 トラブルシューティング

### 問題1: カートが2回表示される

**診断**:
```bash
# ブラウザコンソールで実行
document.querySelectorAll('.cart-section').length
// 結果が 2 の場合は重複している
```

**解決策**:
1. `Ctrl + Shift + R` でハードリフレッシュ
2. `cart.liquid` が以下の内容になっているか確認:
```liquid
{% comment %}
  Cart Template
  カートページテンプレート - 重複表示を防ぐため直接記述
{% endcomment %}

{% section 'cart-section' %}
```

---

### 問題2: 数量変更が保存されない

**診断**:
```javascript
// ブラウザコンソールで実行
fetch('/cart.js').then(r => r.json()).then(cart => console.log(cart))
// 数量を変更して「カートを更新」をクリック
// 再度上記を実行して数量が変わっているか確認
```

**解決策**:
1. コンソールで `Updating cart...` が表示されるか確認
2. `Form submitting with values:` が表示されるか確認
3. ページがリロードされるか確認
4. リロードされない場合は `cart-section.liquid` を再確認

---

### 問題3: チェックアウトでホームに戻される

**診断**:
```javascript
// ブラウザコンソールで実行
fetch('/cart.js').then(r => r.json()).then(cart => {
  console.log('Cart items:', cart.items);
  console.log('Subscription items:', cart.items.filter(item => item.selling_plan_allocation));
})
```

**解決策**:
1. カートが空でないことを確認
2. サブスクリプションプランが選択されているか確認
3. Shopify管理画面で商品の「購入オプション」が有効になっているか確認
4. コンソールに `Proceeding to checkout...` が表示されるか確認

---

## 🔍 診断ツールの使用

### clear-cart.html を使った診断

**ファイルの場所**:
```
/home/user/webapp/clear-cart.html
```

**使い方**:
1. ブラウザで `clear-cart.html` を開く
2. 「カートを確認」をクリック
3. カートの詳細情報を確認
4. 「チェックアウトテスト」をクリック
5. サブスクリプション情報を確認

**出力例**:
```
✓ チェックアウト準備完了
商品数: 1個

商品詳細:
- 植物ケアプラン (1個)
  サブスクリプション: 月額プラン
```

---

## 📊 完全なテストフロー

### ステップ1: カートをクリア
```
① clear-cart.html を開く
② 「カートをクリア」をクリック
③ 「残り商品数: 0個」を確認
```

### ステップ2: 商品を追加
```
① 商品ページに移動
② サブスクリプションプランを選択
③ 数量「1」を確認
④ 「カートに追加」を1回だけクリック
⑤ コンソールで "Item quantity: 1" を確認
⑥ カートページに自動遷移
```

### ステップ3: カート表示を確認
```
① カートが1回だけ表示されることを確認
② 商品が1個表示されることを確認
③ 数量が「1」になっていることを確認
④ 価格が正しく表示されることを確認
```

### ステップ4: 数量変更テスト
```
① +ボタンをクリック（数量が2になる）
② 表示価格が2倍になることを確認（JavaScript）
③ 「カートを更新」ボタンをクリック
④ ページがリロードされる
⑤ 数量が「2」のままであることを確認
⑥ 価格が2倍のままであることを確認
```

### ステップ5: チェックアウトテスト
```
① 「レジに進む」ボタンをクリック
② コンソールで "Proceeding to checkout..." を確認
③ 3-5秒待つ
④ チェックアウトページが表示される
⑤ URLが /checkout になっている
⑥ クレジットカード入力フォームが表示される
⑦ ホームに戻されない ✓
```

---

## ✅ 成功基準

すべてのテストが以下の状態になれば成功:

- [x] カートが1回だけ表示される
- [x] 数量変更後「カートを更新」で保存される
- [x] ページリロード後も数量が保持される
- [x] 価格が正しく計算される
- [x] チェックアウトページが表示される
- [x] ホームにリダイレクトされない

---

## 🆘 それでも問題が解決しない場合

1. **コンソールログを確認**
   - F12 → Console タブ
   - 赤いエラーメッセージをコピー

2. **カート状態を確認**
   - `clear-cart.html` で詳細情報を確認
   - スクリーンショットを取る

3. **ブラウザ情報**
   - 使用ブラウザとバージョンを確認
   - 別のブラウザでテスト

4. **Shopify設定を確認**
   - 商品の「購入オプション」が有効か
   - サブスクリプションプランが正しく設定されているか
   - チェックアウト設定が有効か

---

## 📝 レポートフォーマット

問題が発生した場合、以下の情報を報告してください:

```
### 問題の説明
[問題の詳細を記入]

### 実行したテスト
- [ ] テスト1: カートの重複表示確認
- [ ] テスト2: 数量更新の確認
- [ ] テスト3: チェックアウトの確認

### コンソール出力
```
[コンソールのログをコピー]
```

### スクリーンショット
[必要に応じてスクリーンショットを添付]

### ブラウザ情報
- ブラウザ: [Chrome/Firefox/Safari など]
- バージョン: [バージョン番号]
```

---

最終更新: 2025-11-07
