{% comment %}
  Product Info Section
  å•†å“æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
{% endcomment %}

<div class="product-section">
  <div class="container">
    <div class="product-grid">
      <!-- Product Images -->
      <div class="product-images">
        {% if product.featured_image %}
          <div class="product-image-main">
            <img src="{{ product.featured_image | img_url: '800x800' }}" 
                 alt="{{ product.featured_image.alt | escape }}"
                 loading="lazy">
          </div>
        {% endif %}
        
        {% if product.images.size > 1 %}
          <div class="product-image-thumbnails">
            {% for image in product.images limit: 4 %}
              <div class="thumbnail">
                <img src="{{ image | img_url: '200x200' }}" 
                     alt="{{ image.alt | escape }}"
                     loading="lazy">
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <h1 class="product-title">{{ product.title }}</h1>
        
        <div class="product-price">
          <span class="price">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="compare-price">{{ product.compare_at_price | money }}</span>
          {% endif %}
        </div>

        <div class="product-description">
          {{ product.description }}
        </div>

        <!-- Product Form with Subscription Support -->
        <form method="post" action="/cart/add" id="product-form" class="product-form">
          <input type="hidden" name="form_type" value="product">
          <input type="hidden" name="utf8" value="âœ“">
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="product-variant-id">
          
          <div class="product-variants">
            {% unless product.has_only_default_variant %}
              {% for option in product.options_with_values %}
                <div class="product-option">
                  <label>{{ option.name }}</label>
                  <select name="option{{ forloop.index }}" id="option-{{ forloop.index }}">
                    {% for value in option.values %}
                      <option value="{{ value | escape }}">{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}
            {% endunless %}
          </div>

          {% comment %}
            ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³é¸æŠ
            Check if the first variant has selling plans
          {% endcomment %}
          {% assign first_variant = product.selected_or_first_available_variant %}
          {% if first_variant.selling_plan_allocations.size > 0 %}
            <div class="product-option product-selling-plan">
              <label for="selling-plan-select">
                è³¼å…¥ãƒ—ãƒ©ãƒ³ <span class="required-badge">å¿…é ˆ</span>
              </label>
              <select name="selling_plan" id="selling-plan-select" required class="selling-plan-select">
                <option value="" disabled selected>ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                {% for allocation in first_variant.selling_plan_allocations %}
                  <option value="{{ allocation.selling_plan.id }}" 
                          data-price="{{ allocation.price }}"
                          data-compare-price="{{ allocation.compare_at_price }}">
                    {{ allocation.selling_plan.name }}
                    {% if allocation.selling_plan.price_adjustments.size > 0 %}
                      {% assign adjustment = allocation.selling_plan.price_adjustments.first %}
                      {% if adjustment.value_type == 'percentage' %}
                        ï¼ˆ{{ adjustment.value }}% ã‚ªãƒ•ï¼‰
                      {% elsif adjustment.value_type == 'fixed_amount' %}
                        ï¼ˆ{{ adjustment.value | money }} ã‚ªãƒ•ï¼‰
                      {% endif %}
                    {% endif %}
                    - {{ allocation.price | money }}
                  </option>
                {% endfor %}
              </select>
              <p class="plan-description">
                ğŸ“¦ å®šæœŸè³¼å…¥ãƒ—ãƒ©ãƒ³ã§ä¾¿åˆ©ã«æ¤ç‰©ã‚±ã‚¢ã‚’ç¶™ç¶šã§ãã¾ã™
              </p>
            </div>
          {% endif %}

          <div class="product-quantity">
            <label for="product-quantity">æ•°é‡</label>
            <div class="quantity-selector">
              <button type="button" class="quantity-btn quantity-minus" id="quantity-minus">âˆ’</button>
              <input type="number" 
                     name="quantity" 
                     id="product-quantity" 
                     class="quantity-input"
                     value="1" 
                     min="1" 
                     max="99">
              <button type="button" class="quantity-btn quantity-plus" id="quantity-plus">+</button>
            </div>
          </div>

          <button type="submit" 
                  class="btn btn-large btn-primary product-add-to-cart"
                  id="add-to-cart-btn">
            {% if product.available %}
              <span class="btn-text">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </span>
              <span class="btn-loading" style="display: none;">
                <svg class="spinner" width="20" height="20" viewBox="0 0 20 20">
                  <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="50" stroke-dashoffset="0">
                    <animateTransform attributeName="transform" type="rotate" from="0 10 10" to="360 10 10" dur="1s" repeatCount="indefinite"/>
                  </circle>
                </svg>
                è¿½åŠ ä¸­...
              </span>
            {% else %}
              å£²ã‚Šåˆ‡ã‚Œ
            {% endif %}
          </button>

          <div class="product-form-message" id="product-form-message" style="display: none;"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.product-section {
  padding: 4rem 0;
}

.product-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4rem;
  align-items: start;
}

.product-image-main img {
  width: 100%;
  height: auto;
  border-radius: 12px;
}

.product-image-thumbnails {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-top: 1rem;
}

.thumbnail img {
  width: 100%;
  height: auto;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.3s;
}

.thumbnail img:hover {
  transform: scale(1.05);
}

.product-title {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  color: var(--primary-color, #2D5F3F);
}

.product-price {
  font-size: 2rem;
  margin-bottom: 2rem;
  color: var(--primary-color, #2D5F3F);
}

.compare-price {
  text-decoration: line-through;
  color: #999;
  margin-left: 1rem;
  font-size: 1.5rem;
}

.product-description {
  margin-bottom: 2rem;
  line-height: 1.8;
  color: #666;
}

.product-option,
.product-quantity {
  margin-bottom: 1.5rem;
}

.product-option label,
.product-quantity label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--primary-color, #2D5F3F);
}

.product-option select,
.product-quantity input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.product-option select:focus,
.product-quantity input:focus {
  outline: none;
  border-color: var(--primary-color, #2D5F3F);
}

.product-selling-plan {
  background: #E8F5E9;
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 1.5rem;
}

.product-selling-plan label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.required-badge {
  background: #d32f2f;
  color: white;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 700;
}

.selling-plan-select {
  background: white;
}

.plan-description {
  margin-top: 0.75rem;
  font-size: 0.9rem;
  color: #666;
}

/* Quantity Selector */
.quantity-selector {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  max-width: 200px;
}

.quantity-btn {
  width: 40px;
  height: 40px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  color: var(--primary-color, #2D5F3F);
  font-weight: 600;
}

.quantity-btn:hover {
  border-color: var(--primary-color, #2D5F3F);
  background: rgba(45, 95, 63, 0.05);
}

.quantity-btn:active {
  transform: scale(0.95);
}

.quantity-input {
  width: 70px;
  height: 40px;
  text-align: center;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
}

.product-add-to-cart {
  width: 100%;
  margin-top: 2rem;
  position: relative;
  overflow: hidden;
}

.product-add-to-cart[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.product-form-message {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 8px;
  font-weight: 600;
  text-align: center;
}

.product-form-message.success {
  background: #E8F5E9;
  color: var(--primary-color, #2D5F3F);
}

.product-form-message.error {
  background: #ffebee;
  color: #d32f2f;
}

@media (max-width: 768px) {
  .product-grid {
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  
  .product-title {
    font-size: 1.75rem;
  }
  
  .product-price {
    font-size: 1.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const productForm = document.getElementById('product-form');
  const quantityInput = document.getElementById('product-quantity');
  const minusBtn = document.getElementById('quantity-minus');
  const plusBtn = document.getElementById('quantity-plus');
  const addToCartBtn = document.getElementById('add-to-cart-btn');
  const messageDiv = document.getElementById('product-form-message');

  // æ•°é‡å¤‰æ›´ãƒœã‚¿ãƒ³
  if (minusBtn) {
    minusBtn.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value) || 1;
      quantityInput.value = Math.max(currentValue - 1, 1);
    });
  }

  if (plusBtn) {
    plusBtn.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value) || 1;
      quantityInput.value = Math.min(currentValue + 1, 99);
    });
  }

  // æ•°é‡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
  if (quantityInput) {
    quantityInput.addEventListener('change', function() {
      const value = parseInt(this.value) || 1;
      this.value = Math.max(1, Math.min(value, 99));
    });

    quantityInput.addEventListener('blur', function() {
      if (!this.value || parseInt(this.value) < 1) {
        this.value = 1;
      }
    });
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
  if (productForm) {
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯
      const sellingPlanSelect = document.getElementById('selling-plan-select');
      if (sellingPlanSelect && !sellingPlanSelect.value) {
        showMessage('è³¼å…¥ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        sellingPlanSelect.focus();
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      const btnText = addToCartBtn.querySelector('.btn-text');
      const btnLoading = addToCartBtn.querySelector('.btn-loading');
      
      if (btnText) btnText.style.display = 'none';
      if (btnLoading) btnLoading.style.display = 'flex';
      addToCartBtn.disabled = true;

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
      const formData = new FormData(productForm);

      // ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
      const formDataObj = Object.fromEntries(formData);
      console.log('Form data being sent:', formDataObj);
      
      // é‡è¤‡è¿½åŠ ã‚’é˜²ããŸã‚ã®ãƒ•ãƒ©ã‚°
      if (window.isAddingToCart) {
        console.log('Already adding to cart, preventing duplicate');
        return;
      }
      window.isAddingToCart = true;

      // Fetch APIã§ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(formDataObj)
      })
      .then(response => {
        console.log('Cart add response status:', response.status);
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.description || 'ã‚«ãƒ¼ãƒˆã¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Successfully added to cart:', data);
        console.log('Item quantity:', data.quantity);
        console.log('Selling plan:', data.selling_plan_allocation);
        
        showMessage('âœ“ ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼', 'success');
        
        // 1.5ç§’å¾Œã«ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        setTimeout(() => {
          window.location.href = '/cart';
        }, 1500);
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
        showMessage('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (btnText) btnText.style.display = 'inline';
        if (btnLoading) btnLoading.style.display = 'none';
        addToCartBtn.disabled = false;
        window.isAddingToCart = false;
      });
    });
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function showMessage(message, type) {
    if (messageDiv) {
      messageDiv.textContent = message;
      messageDiv.className = 'product-form-message ' + type;
      messageDiv.style.display = 'block';
      
      // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  }

  // ãƒãƒªã‚¢ãƒ³ãƒˆå¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  const variantSelects = productForm.querySelectorAll('[name^="option"]');
  variantSelects.forEach(select => {
    select.addEventListener('change', updateVariant);
  });

  function updateVariant() {
    // ã“ã®é–¢æ•°ã¯å¿…è¦ã«å¿œã˜ã¦ãƒãƒªã‚¢ãƒ³ãƒˆå¤‰æ›´æ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
    // ç¾åœ¨ã¯åŸºæœ¬çš„ãªå®Ÿè£…ã®ã¿
  }
});
</script>

{% schema %}
{
  "name": "Product Info",
  "settings": [],
  "presets": [
    {
      "name": "Product Info"
    }
  ]
}
{% endschema %}
